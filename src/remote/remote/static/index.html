<!DOCTYPE html>
<html>
<head>
<title>Pico Garage Opener</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<meta name="mobile-web-app-capable" content="yes" />
<link rel="icon" type="image/x-icon" href="/favicon.ico">
<link rel="icon" href="icon.png">
<link rel="apple-touch-icon" href="/icon192.png">
<link rel="manifest" href="/manifest.json">
</head>
<body>
<style type="text/css">
#Submit {
color: white;
font-size: 20px;
font-weight: bold;
margin: 70px;
margin-top: 10px;
height: 200px;
width: 250px;
position: center;
text-align: center;
border-width: 4px 4px;
position:center;
right:0px;
padding: 0px;}
#Status {
font-size: 20px;
font-weight: bold;
margin: 70px;
margin-top: 10px;
height: 100px;
width: 250px;
position: center;
text-align: center;
border-width: 4px 4px;
position:center;
right:0px;
padding: 0px;}
body{
margin: 5px;
font-family: Helvetica;
text-align: center;
min-height: 30px;
width: 100%;
background-position: center top;
text-align: center;
font-size: 20px;
padding: 11px 0px 12px 0px;
font-weight: bold;}
.hidden{display: none;}
.show{display: block;}
.done{opacity:0.2;}
.notdone{opacity:1;}
</style>

<script language="javascript" >
function waitWarn(a) {
    // Send request via fetch instead of form submit to prevent full page reload
    document.getElementById("warnLabel").innerHTML = "Please wait...";
    document.getElementById("Submit").disabled = true;
    document.getElementById("Status").disabled = true;

    if (a === 0) {
        // Handle "Run Control" click
        fetch('./run') // Use fetch for the run command
            .then(response => {
                if (response.ok) {
                    console.log("Run control successful.");
                    // Immediately request an update after sending the command
                    // Add a small delay for the physical action to start/stop
                    setTimeout(updateStatus, 1000); 
                } else {
                    throw new Error('Run command failed.');
                }
            })
            .catch(error => {
                console.error('Run Error:', error);
                document.getElementById("warnLabel").textContent = "Error during RUN.";
                updateStatus(); // Re-enable buttons
            });
    } else if (a === 1) {
        // Handle "Update Status" click
        updateStatus();
    }
}

function updateStatus() {
    fetch('/api/status')
    .then(response => response.json())
    .then(data => {
        
        let submitButton = document.getElementById("Submit");
        
        // 1. Update Door Status
        document.getElementById("door_status").textContent = data.state;
        
        // 2. Update Submit Button
        submitButton.value = data.button_text;
        submitButton.style.backgroundColor = data.button_color;
        
        // 3. Update onboard Temperature
        document.getElementById("temp_display").textContent = data.temperature;
        
        // 4. Update station, external temperature and relative humidity
        document.getElementById("station").textContent = data.station;
        document.getElementById("ext_temperature").textContent = data.ext_temperature;
        document.getElementById("ext_RH").textContent = data.ext_RH;
        
        // 5. Update Time, IP and version
        document.getElementById("datetime").textContent = data.datetime;
        document.getElementById("ip_address").textContent = data.ip;
        document.getElementById("version").textContent = data.version;
        
        // 6. Reset Warning and buttons
        document.getElementById("warnLabel").textContent = "Ready"; 
        submitButton.disabled = false;
        document.getElementById("Status").disabled = false;
    })
    .catch(error => {
        console.error('Error fetching status:', error);
        document.getElementById("warnLabel").textContent = "Error: Check connection.";
        // Re-enable buttons even on error, so user can try again
        document.getElementById("Submit").disabled = false;
        document.getElementById("Status").disabled = false;
    });
}

// Start the status update when the page is fully loaded
document.addEventListener('DOMContentLoaded', updateStatus);
// Optionally, update status every 10 seconds automatically
setInterval(updateStatus, 10000); 
</script>

<form name="submitForm">
    <input type="button" id="Submit" value="Loading..." onclick="waitWarn(0)" />
</form>

Door status is: <span id="door_status">Loading...</span>

<form name="statusForm">
    <input type="button" id="Status" value="Update Status" onclick="waitWarn(1)" />
    <br><label id="warnLabel">Ready</label>
</form>

<br>Indoor Temperature: <span id="temp_display">Loading...</span>
<br>
<br>Temperature: <span id="ext_temperature">Loading...</span>
<br>Relative Humidity: <span id="ext_RH">Loading...</span>
<br><small><br>Weather station: <span id="station">Loading...</span>
<br><span id="datetime">Time N/A</span></small>

<br><br><small><small>Device IP: <span id="ip_address">N/A</span></small></small>
<br><small><small>Version: <span id="version">Version: N/A</span></small></small>
</body>
</html>
